<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة حجوزات الفلل</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect fill='%231565c0' width='100' height='100' rx='20'/%3e%3cpath fill='white' d='M20,70 L50,40 L80,70 L80,85 L65,85 L65,70 L50,70 L50,85 L35,85 L35,70 Z'/%3e%3crect fill='%23ef6c00' x='52' y='60' width='6' height='8'/%3e%3crect fill='%23ef6c00' x='42' y='60' width='6' height='8'/%3e%3c/svg%3e" type="image/svg+xml">
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
    --primary: #1a5f4a;           /* أخضر داكن */
    --primary-light: #2d8a6e;
    --primary-dark: #0f3d2e;
    --secondary: #c9a227;          /* ذهبي */
    --background: #faf8f5;         /* بيج فاتح */
    --surface: #ffffff;
    --text-primary: #1a1a1a;
    --text-secondary: #5a5a5a;
    --border: #e0dcd5;
    --success: #2d8a6e;
    --warning: #c9a227;
    --danger: #c44536;
    --info: #4a90a4;
    --sidebar-width: 250px;
    --header-height: 60px;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Tajawal', sans-serif;
}

body {
    background-color: var(--background);
    color: var(--text-primary);
    display: flex;
    min-height: 100vh;
    overflow-x: hidden;
}

/* Sidebar */
.sidebar {
    width: var(--sidebar-width);
    background-color: var(--primary);
    color: white;
    display: flex;
    flex-direction: column;
    position: fixed;
    right: 0;
    top: 0;
    bottom: 0;
    z-index: 100;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.logo-container {
    padding: 20px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.logo-text {
    font-weight: 800;
    font-size: 1.5rem;
    color: var(--secondary);
}

.nav-links {
    list-style: none;
    padding: 20px 0;
    flex: 1;
}

.nav-item {
    margin-bottom: 5px;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 12px 25px;
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    transition: all 0.2s;
    cursor: pointer;
}

.nav-link:hover, .nav-link.active {
    background-color: rgba(255,255,255,0.1);
    color: white;
    border-right: 4px solid var(--secondary);
}

.nav-link i {
    margin-left: 15px;
    width: 20px;
    text-align: center;
}

/* Main Content */
.main-content {
    margin-right: var(--sidebar-width);
    width: calc(100% - var(--sidebar-width));
    padding: 30px;
    transition: margin-right 0.3s ease, width 0.3s ease;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.page-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--primary);
}

/* Loading Overlay */
#loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid var(--border);
    border-top: 5px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Cards */
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--surface);
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-md);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-left: 15px;
}

.stat-icon.revenue { background: #e8f5e9; color: var(--success); }
.stat-icon.bookings { background: #e3f2fd; color: var(--info); }
.stat-icon.expenses { background: #ffebee; color: var(--danger); }
.stat-icon.net { background: #fff8e1; color: var(--warning); }

.stat-info h3 {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 5px;
}

.stat-info .value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
}

/* Charts */
.charts-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-container {
    background: var(--surface);
    padding: 20px;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    height: 350px;
    position: relative;
}

.chart-container canvas {
    max-width: 100% !important;
    max-height: 280px !important;
}

.chart-container h3 {
    margin-bottom: 15px;
    color: var(--text-secondary);
    font-size: 1.1rem;
}

/* Tables */
.table-container {
    background: var(--surface);
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    margin-bottom: 30px;
}

.table-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 15px 20px;
    text-align: right;
    border-bottom: 1px solid var(--border);
}

th {
    background-color: #f8f9fa;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 0.9rem;
}

tr:hover {
    background-color: #fcfcfc;
}

tr:last-child td {
    border-bottom: none;
}

/* Forms */
.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    color: var(--text-secondary);
    font-weight: 500;
}

.form-control {
    width: 100%;
    padding: 10px 15px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
}

textarea.form-control {
    min-height: 100px;
    resize: vertical;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background-color: var(--primary);
    color: white;
}
.btn-primary:hover { background-color: var(--primary-light); }

.btn-secondary {
    background-color: #e0e0e0;
    color: var(--text-primary);
}
.btn-secondary:hover { background-color: #d0d0d0; }

.btn-danger {
    background-color: var(--danger);
    color: white;
}
.btn-danger:hover { background-color: #a33225; }

.btn-sm {
    padding: 5px 10px;
    font-size: 0.85rem;
}

.action-btns {
    display: flex;
    gap: 5px;
}

/* Filters */
.filters-bar {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    background: var(--surface);
    padding: 15px;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
}

.filter-item {
    flex: 1;
    min-width: 200px;
}

/* Villa Selection */
.villa-selector {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.villa-option {
    cursor: pointer;
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    transition: all 0.2s;
}

.villa-option:hover {
    border-color: var(--primary-light);
    background-color: #f0f7f4;
}

.villa-option.selected {
    border-color: var(--primary);
    background-color: #e8f5e9;
    color: var(--primary);
}

.villa-option i {
    font-size: 2rem;
    margin-bottom: 10px;
    display: block;
}

/* Badges */
.badge {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.badge-villa-1 { background: #e3f2fd; color: #1565c0; }
.badge-villa-2 { background: #f3e5f5; color: #7b1fa2; }
.badge-villa-3 { background: #fff3e0; color: #ef6c00; }
.badge-villa-4 { background: #e8f5e9; color: #2e7d32; }

.badge-confirmed { background: #e8f5e9; color: #2e7d32; }
.badge-pending { background: #fff8e1; color: #f57c00; }
.badge-cancelled { background: #ffebee; color: #c62828; }

/* Tabs */
.tabs {
    display: flex;
    border-bottom: 2px solid var(--border);
    margin-bottom: 20px;
}

.tab {
    padding: 12px 25px;
    cursor: pointer;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
}

.tab:hover { color: var(--primary); }
.tab.active { color: var(--primary); border-bottom-color: var(--primary); }

/* Modals */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal {
    background: var(--surface);
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-md);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 1.2rem;
    font-weight: 700;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 2000;
}

.toast {
    background: white;
    min-width: 300px;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-top: 10px;
    display: flex;
    align-items: center;
    border-right: 4px solid transparent;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from { transform: translateX(-100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.toast.success { border-right-color: var(--success); }
.toast.error { border-right-color: var(--danger); }
.toast.info { border-right-color: var(--info); }

.toast i { margin-left: 10px; font-size: 1.2rem; }
.toast.success i { color: var(--success); }
.toast.error i { color: var(--danger); }
.toast.info i { color: var(--info); }

/* Pages visibility */
section[id^="page-"] {
    display: none;
    animation: fadeIn 0.3s ease;
}

section[id^="page-"].active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 768px) {
    .sidebar { transform: translateX(100%); }
    .sidebar.mobile-open { transform: translateX(0); }
    .main-content { margin-right: 0; width: 100%; }
    .mobile-menu-btn { display: block !important; }
    .villa-selector { grid-template-columns: repeat(2, 1fr); }
    .charts-row { grid-template-columns: 1fr; }
}

/* --- Mobile enhancements (keeps desktop look, improves touch & spacing) --- */
@media (max-width: 768px) {
  body { overflow-x: hidden; }
  .main-content { padding: 16px; }
  .page-header { flex-direction: column; align-items: flex-start; gap: 10px; }
  .page-title { font-size: 1.4rem; }
  .actions { width: 100%; display: flex; flex-wrap: wrap; gap: 10px; }
  .actions .form-control { width: 100% !important; }
  #custom-period-inputs { width: 100%; display: flex; flex-wrap: wrap; gap: 10px; margin-right: 0 !important; }
  #custom-period-inputs input { width: 100% !important; margin: 0 !important; }
  .cards-grid { gap: 12px; }
  .stat-card { padding: 16px; }
  .stat-info .value { font-size: 1.35rem; }
  .filters-bar { padding: 12px; gap: 10px; }
  .filter-item { min-width: 100%; }
  th, td { padding: 10px 12px; font-size: 0.92rem; }
  .btn { padding: 10px 14px; }
  .btn-sm { padding: 8px 10px; }
  .action-btns { gap: 8px; }
  .chart-container { height: 320px; padding: 16px; }
  .chart-container canvas { max-height: 240px !important; }
  .table-header { padding: 14px 16px; }
  .table-container { border-radius: 14px; }
  .toast-container { left: 12px; right: 12px; bottom: 12px; }
  .toast { min-width: 0; width: 100%; }
  .modal { width: 94%; max-height: 92vh; }
  .modal-header, .modal-body, .modal-footer { padding: 14px 16px; }
  .villa-selector { gap: 10px; }
  .villa-option { padding: 14px 10px; }
}

/* Extra small phones */
@media (max-width: 420px) {
  .page-title { font-size: 1.25rem; }
  .stat-icon { width: 44px; height: 44px; font-size: 1.25rem; }
  .stat-info .value { font-size: 1.2rem; }
  th, td { padding: 9px 10px; font-size: 0.88rem; }
}

/* Better focus visibility for keyboard users */
:focus-visible {
  outline: 3px solid rgba(26, 95, 74, 0.35);
  outline-offset: 2px;
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce) {
  * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
}

/* --- Mobile detection class (JS adds .is-mobile) --- */
body.is-mobile {
  -webkit-text-size-adjust: 100%;
}
body.is-mobile .page-title { font-size: 1.35rem; }
body.is-mobile th, body.is-mobile td { font-size: 0.9rem; padding: 10px 12px; }
body.is-mobile .btn { padding: 10px 14px; }
body.is-mobile .btn-sm { padding: 8px 10px; }
body.is-mobile .form-control { font-size: 0.95rem; padding: 9px 12px; }
body.is-mobile .sidebar { box-shadow: -2px 0 14px rgba(0,0,0,0.12); }


/* Searchable nationality picker */
.searchable-select{
    position: relative;
}
.searchable-select .form-control{
    padding-left: 36px;
    cursor: pointer;
    background: #fff;
}
.searchable-select .select-caret{
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
    pointer-events: none;
    font-size: 14px;
}
.nationality-list{
    margin-top: 12px;
    max-height: 55vh;
    overflow: auto;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--surface);
}
.nationality-item{
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    display:flex;
    align-items:center;
    justify-content: space-between;
}
.nationality-item:last-child{ border-bottom: none; }
.nationality-item:hover{ background: rgba(0,0,0,0.03); }
.nationality-item.active{ background: rgba(26,95,74,0.10); font-weight: 700; }
.nationality-empty{
    padding: 16px;
    color: var(--text-secondary);
    text-align: center;
}

</style>

</head>
<body>
    <!-- Initial Loader -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>جاري تحميل النظام...</p>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="logo-container">
            <div class="logo-text">
                <i class="fa-solid fa-hotel" style="margin-left: 10px;"></i>
                فللي
            </div>
            <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">نظام إدارة الحجوزات</div>
        </div>
        
        <ul class="nav-links">
            <li class="nav-item">
                <a class="nav-link active" onclick="navigateTo('dashboard')">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>لوحة التحكم</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="navigateTo('new-booking')">
                    <i class="fa-solid fa-plus-circle"></i>
                    <span>حجز جديد</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="navigateTo('bookings')">
                    <i class="fa-solid fa-calendar-check"></i>
                    <span>الحجوزات</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="navigateTo('villa-expenses')">
                    <i class="fa-solid fa-home"></i>
                    <span>مصاريف الفلل</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="navigateTo('shared-expenses')">
                    <i class="fa-solid fa-wallet"></i>
                    <span>مصاريف مشتركة</span>
                </a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" onclick="navigateTo('employee-expenses')">
                    <i class="fa-solid fa-users"></i>
                    <span>رواتب الموظفين</span>
                </a>
            </li>
<li class="nav-item">
                <a class="nav-link" onclick="navigateTo('settings')">
                    <i class="fa-solid fa-cog"></i>
                    <span>الإعدادات</span>
                </a>
            </li>
        </ul>
        
        <div style="padding: 20px; text-align: center; font-size: 0.8rem; opacity: 0.5;">
            الإصدار 1.0<br>&copy; 2026
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Mobile Header -->
        <div style="display: none; margin-bottom: 20px;" class="mobile-menu-btn">
            <button class="btn btn-secondary" onclick="toggleSidebar()">
                <i class="fa-solid fa-bars"></i> القائمة
            </button>
        </div>

        <!-- Dashboard Page -->
        <section id="page-dashboard" class="active">
            <div class="page-header">
                <h1 class="page-title">لوحة التحكم</h1>
                <div class="actions">
                    <select id="dashboard-period" class="form-control" style="width: auto;" onchange="loadDashboard()">
                        <option value="this_month">هذا الشهر</option>
                        <option value="last_month">الشهر الماضي</option>
                        <option value="this_year">هذه السنة</option>
                        <option value="custom">فترة مخصصة</option>
                        <option value="all">كل الفترات</option>
                    </select>
                    <div id="custom-period-inputs" style="display: none; margin-right: 10px;">
                        <input type="date" id="custom-start-date" class="form-control" style="width: auto; display: inline-block; margin-left: 5px;" onchange="loadDashboard()">
                        <span style="margin: 0 5px;">إلى</span>
                        <input type="date" id="custom-end-date" class="form-control" style="width: auto; display: inline-block;" onchange="loadDashboard()">
                    </div>
                </div>
            </div>

            <div class="cards-grid">
                <div class="stat-card">
                    <div class="stat-icon revenue">
                        <i class="fa-solid fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-info">
                        <h3>إجمالي الإيرادات</h3>
                        <div class="value" id="stat-revenue">0.000</div>
                        <small>ار.ع</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bookings">
                        <i class="fa-solid fa-calendar-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3>عدد الحجوزات</h3>
                        <div class="value" id="stat-bookings-count">0</div>
                        <small>حجز</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon expenses">
                        <i class="fa-solid fa-file-invoice-dollar"></i>
                    </div>
                    <div class="stat-info">
                        <h3>إجمالي المصاريف</h3>
                        <div class="value" id="stat-expenses">0.000</div>
                        <small>ار.ع</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon net">
                        <i class="fa-solid fa-scale-balanced"></i>
                    </div>
                    <div class="stat-info">
                        <h3>صافي الربح</h3>
                        <div class="value" id="stat-net">0.000</div>
                        <small>ار.ع</small>
                    </div>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-container">
                    <h3>الإيرادات الشهرية</h3>
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>توزيع الحجوزات حسب الفيلا</h3>
                    <canvas id="villasChart"></canvas>
                </div>
            </div>

             <div class="charts-row">
                <div class="chart-container">
                    <h3>مصادر الحجوزات</h3>
                    <canvas id="methodsChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>توزيع المصاريف</h3>
                    <canvas id="expensesChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3>آخر الحجوزات المضافة</h3>
                    <button class="btn btn-sm btn-primary" onclick="navigateTo('bookings')">عرض الكل</button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="recent-bookings-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>العميل</th>
                                <th>الفيلا</th>
                                <th>المدة</th>
                                <th>البالغين</th>
                                <th>الأطفال</th>
                                <th>المبلغ</th>
                                <th>التأمين</th>
                                <th>الخصم</th>
                                <th>المبلغ المدفوع</th>
                                <th>المتبقي</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- New Booking Page -->
        <section id="page-new-booking">
            <div class="page-header">
                <h1 class="page-title">حجز جديد</h1>
            </div>

            <form id="new-booking-form" onsubmit="saveBooking(event)">
                <div class="table-container" style="padding: 25px;">
                    <h3 style="margin-bottom: 20px;">اختيار الفيلا</h3>
                    <div class="villa-selector">
                        <div class="villa-option" onclick="selectVilla(1, this)" id="villa-opt-1">
                            <i class="fa-solid fa-house" style="color: #1565c0;"></i>
                            <div>فيلا 1</div>
                        </div>
                        <div class="villa-option" onclick="selectVilla(2, this)" id="villa-opt-2">
                            <i class="fa-solid fa-house" style="color: #7b1fa2;"></i>
                            <div>فيلا 2</div>
                        </div>
                        <div class="villa-option" onclick="selectVilla(3, this)" id="villa-opt-3">
                            <i class="fa-solid fa-house" style="color: #ef6c00;"></i>
                            <div>فيلا 3</div>
                        </div>
                        <div class="villa-option" onclick="selectVilla(4, this)" id="villa-opt-4">
                            <i class="fa-solid fa-house" style="color: #2e7d32;"></i>
                            <div>فيلا 4</div>
                        </div>
                    </div>
                    <input type="hidden" id="booking-villa" required>
                     <div id="selected-villas-label" style="margin-top:10px; color: var(--text-secondary); font-size: 0.95rem;">لم يتم اختيار أي فيلا</div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3 style="margin-bottom: 20px; margin-top: 10px;">بيانات العميل</h3>
                            <div class="form-group">
                                <label class="form-label">اسم العميل *</label>
                                <input type="text" class="form-control" id="booking-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">رقم الهاتف *</label>
                                <input type="tel" class="form-control" id="booking-phone" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">رقم الهوية / الجواز</label>
                                <input type="text" class="form-control" id="booking-id-num">
                            </div>

                            <div class="form-group">
                                <label class="form-label">الجنسية</label>
                                <div class="searchable-select">
                                    <input type="text" class="form-control" id="booking-nationality-display" placeholder="اختر الجنسية" readonly onclick="openNationalityModal('booking-nationality','booking-nationality-display')">
                                    <i class="fa-solid fa-chevron-down select-caret"></i>
                                </div>
                                <select class="form-control" id="booking-nationality" style="display:none;">

                                    <option value="أفغانستان">أفغانستان</option>
                                    <option value="ألبانيا">ألبانيا</option>
                                    <option value="الجزائر">الجزائر</option>
                                    <option value="أندورا">أندورا</option>
                                    <option value="أنغولا">أنغولا</option>
                                    <option value="أنتيغوا وبربودا">أنتيغوا وبربودا</option>
                                    <option value="الأرجنتين">الأرجنتين</option>
                                    <option value="أرمينيا">أرمينيا</option>
                                    <option value="أستراليا">أستراليا</option>
                                    <option value="النمسا">النمسا</option>
                                    <option value="أذربيجان">أذربيجان</option>
                                    <option value="جزر البهاما">جزر البهاما</option>
                                    <option value="البحرين">البحرين</option>
                                    <option value="بنغلاديش">بنغلاديش</option>
                                    <option value="باربادوس">باربادوس</option>
                                    <option value="بيلاروس">بيلاروس</option>
                                    <option value="بلجيكا">بلجيكا</option>
                                    <option value="بليز">بليز</option>
                                    <option value="بنين">بنين</option>
                                    <option value="بوتان">بوتان</option>
                                    <option value="بوليفيا">بوليفيا</option>
                                    <option value="البوسنة والهرسك">البوسنة والهرسك</option>
                                    <option value="بوتسوانا">بوتسوانا</option>
                                    <option value="البرازيل">البرازيل</option>
                                    <option value="بروناي">بروناي</option>
                                    <option value="بلغاريا">بلغاريا</option>
                                    <option value="بوركينا فاسو">بوركينا فاسو</option>
                                    <option value="بوروندي">بوروندي</option>
                                    <option value="كمبوديا">كمبوديا</option>
                                    <option value="الكاميرون">الكاميرون</option>
                                    <option value="كندا">كندا</option>
                                    <option value="الرأس الأخضر">الرأس الأخضر</option>
                                    <option value="تشاد">تشاد</option>
                                    <option value="تشيلي">تشيلي</option>
                                    <option value="الصين">الصين</option>
                                    <option value="كولومبيا">كولومبيا</option>
                                    <option value="جزر القمر">جزر القمر</option>
                                    <option value="الكونغو">الكونغو</option>
                                    <option value="كوستاريكا">كوستاريكا</option>
                                    <option value="ساحل العاج">ساحل العاج</option>
                                    <option value="كرواتيا">كرواتيا</option>
                                    <option value="كوبا">كوبا</option>
                                    <option value="قبرص">قبرص</option>
                                    <option value="التشيك">التشيك</option>
                                    <option value="الدانمارك">الدانمارك</option>
                                    <option value="جيبوتي">جيبوتي</option>
                                    <option value="دومينيكا">دومينيكا</option>
                                    <option value="جمهورية الدومينيكان">جمهورية الدومينيكان</option>
                                    <option value="الإكوادور">الإكوادور</option>
                                    <option value="مصر">مصر</option>
                                    <option value="السلفادور">السلفادور</option>
                                    <option value="غينيا الاستوائية">غينيا الاستوائية</option>
                                    <option value="إريتريا">إريتريا</option>
                                    <option value="إستونيا">إستونيا</option>
                                    <option value="إسواتيني">إسواتيني</option>
                                    <option value="إثيوبيا">إثيوبيا</option>
                                    <option value="فيجي">فيجي</option>
                                    <option value="فنلندا">فنلندا</option>
                                    <option value="فرنسا">فرنسا</option>
                                    <option value="الغابون">الغابون</option>
                                    <option value="غامبيا">غامبيا</option>
                                    <option value="جورجيا">جورجيا</option>
                                    <option value="ألمانيا">ألمانيا</option>
                                    <option value="غانا">غانا</option>
                                    <option value="اليونان">اليونان</option>
                                    <option value="غرينادا">غرينادا</option>
                                    <option value="غواتيمالا">غواتيمالا</option>
                                    <option value="غينيا">غينيا</option>
                                    <option value="غينيا بيساو">غينيا بيساو</option>
                                    <option value="غيانا">غيانا</option>
                                    <option value="هايتي">هايتي</option>
                                    <option value="هندوراس">هندوراس</option>
                                    <option value="المجر">المجر</option>
                                    <option value="آيسلندا">آيسلندا</option>
                                    <option value="الهند">الهند</option>
                                    <option value="إندونيسيا">إندونيسيا</option>
                                    <option value="إيران">إيران</option>
                                    <option value="العراق">العراق</option>
                                    <option value="إيرلندا">إيرلندا</option>
                                    <option value="إيطاليا">إيطاليا</option>
                                    <option value="جامايكا">جامايكا</option>
                                    <option value="اليابان">اليابان</option>
                                    <option value="الأردن">الأردن</option>
                                    <option value="كازاخستان">كازاخستان</option>
                                    <option value="كينيا">كينيا</option>
                                    <option value="كيريباتي">كيريباتي</option>
                                    <option value="الكويت">الكويت</option>
                                    <option value="قيرغيزستان">قيرغيزستان</option>
                                    <option value="لاوس">لاوس</option>
                                    <option value="لاتفيا">لاتفيا</option>
                                    <option value="لبنان">لبنان</option>
                                    <option value="ليسوتو">ليسوتو</option>
                                    <option value="ليبيريا">ليبيريا</option>
                                    <option value="ليبيا">ليبيا</option>
                                    <option value="ليختنشتاين">ليختنشتاين</option>
                                    <option value="ليتوانيا">ليتوانيا</option>
                                    <option value="لوكسمبورغ">لوكسمبورغ</option>
                                    <option value="مدغشقر">مدغشقر</option>
                                    <option value="مالاوي">مالاوي</option>
                                    <option value="ماليزيا">ماليزيا</option>
                                    <option value="جزر المالديف">جزر المالديف</option>
                                    <option value="مالي">مالي</option>
                                    <option value="مالطا">مالطا</option>
                                    <option value="جزر مارشال">جزر مارشال</option>
                                    <option value="موريتانيا">موريتانيا</option>
                                    <option value="موريشيوس">موريشيوس</option>
                                    <option value="المكسيك">المكسيك</option>
                                    <option value="ميكرونيزيا">ميكرونيزيا</option>
                                    <option value="مولدوفا">مولدوفا</option>
                                    <option value="موناكو">موناكو</option>
                                    <option value="منغوليا">منغوليا</option>
                                    <option value="الجبل الأسود">الجبل الأسود</option>
                                    <option value="المغرب">المغرب</option>
                                    <option value="موزمبيق">موزمبيق</option>
                                    <option value="ميانمار">ميانمار</option>
                                    <option value="ناميبيا">ناميبيا</option>
                                    <option value="ناورو">ناورو</option>
                                    <option value="نيبال">نيبال</option>
                                    <option value="هولندا">هولندا</option>
                                    <option value="نيوزيلندا">نيوزيلندا</option>
                                    <option value="نيكاراغوا">نيكاراغوا</option>
                                    <option value="النيجر">النيجر</option>
                                    <option value="نيجيريا">نيجيريا</option>
                                    <option value="كوريا الشمالية">كوريا الشمالية</option>
                                    <option value="مقدونيا الشمالية">مقدونيا الشمالية</option>
                                    <option value="النرويج">النرويج</option>
                                    <option value="عمان">عمان</option>
                                    <option value="باكستان">باكستان</option>
                                    <option value="بالاو">بالاو</option>
                                    <option value="بنما">بنما</option>
                                    <option value="بابوا غينيا الجديدة">بابوا غينيا الجديدة</option>
                                    <option value="باراغواي">باراغواي</option>
                                    <option value="بيرو">بيرو</option>
                                    <option value="الفلبين">الفلبين</option>
                                    <option value="بولندا">بولندا</option>
                                    <option value="البرتغال">البرتغال</option>
                                    <option value="قطر">قطر</option>
                                    <option value="رومانيا">رومانيا</option>
                                    <option value="روسيا">روسيا</option>
                                    <option value="رواندا">رواندا</option>
                                    <option value="سانت كيتس ونيفيس">سانت كيتس ونيفيس</option>
                                    <option value="سانت لوسيا">سانت لوسيا</option>
                                    <option value="سانت فنسنت والغرينادين">سانت فنسنت والغرينادين</option>
                                    <option value="ساموا">ساموا</option>
                                    <option value="سان مارينو">سان مارينو</option>
                                    <option value="ساو تومي وبرينسيبي">ساو تومي وبرينسيبي</option>
                                    <option value="السعودية">السعودية</option>
                                    <option value="السنغال">السنغال</option>
                                    <option value="صربيا">صربيا</option>
                                    <option value="سيشل">سيشل</option>
                                    <option value="سيراليون">سيراليون</option>
                                    <option value="سنغافورة">سنغافورة</option>
                                    <option value="سلوفاكيا">سلوفاكيا</option>
                                    <option value="سلوفينيا">سلوفينيا</option>
                                    <option value="جزر سليمان">جزر سليمان</option>
                                    <option value="الصومال">الصومال</option>
                                    <option value="جنوب أفريقيا">جنوب أفريقيا</option>
                                    <option value="كوريا الجنوبية">كوريا الجنوبية</option>
                                    <option value="جنوب السودان">جنوب السودان</option>
                                    <option value="إسبانيا">إسبانيا</option>
                                    <option value="سريلانكا">سريلانكا</option>
                                    <option value="السودان">السودان</option>
                                    <option value="سورينام">سورينام</option>
                                    <option value="السويد">السويد</option>
                                    <option value="سويسرا">سويسرا</option>
                                    <option value="سوريا">سوريا</option>
                                    <option value="تايوان">تايوان</option>
                                    <option value="طاجيكستان">طاجيكستان</option>
                                    <option value="تنزانيا">تنزانيا</option>
                                    <option value="تايلاند">تايلاند</option>
                                    <option value="تيمور الشرقية">تيمور الشرقية</option>
                                    <option value="توغو">توغو</option>
                                    <option value="تونغا">تونغا</option>
                                    <option value="ترينيداد وتوباغو">ترينيداد وتوباغو</option>
                                    <option value="تونس">تونس</option>
                                    <option value="تركيا">تركيا</option>
                                    <option value="تركمانستان">تركمانستان</option>
                                    <option value="توفالو">توفالو</option>
                                    <option value="أوغندا">أوغندا</option>
                                    <option value="أوكرانيا">أوكرانيا</option>
                                    <option value="الإمارات">الإمارات</option>
                                    <option value="بريطانيا">بريطانيا</option>
                                    <option value="الولايات المتحدة">الولايات المتحدة</option>
                                    <option value="أوروغواي">أوروغواي</option>
                                    <option value="أوزبكستان">أوزبكستان</option>
                                    <option value="فانواتو">فانواتو</option>
                                    <option value="فنزويلا">فنزويلا</option>
                                    <option value="فيتنام">فيتنام</option>
                                    <option value="اليمن">اليمن</option>
                                    <option value="زامبيا">زامبيا</option>
                                    <option value="زيمبابوي">زيمبابوي</option>
                                    <option value="أخرى">أخرى</option>
                                                                </select>
                            </div>

                            <div id="customer-history" style="margin-top:-10px; margin-bottom: 15px; color: var(--text-secondary); font-size: 0.9rem;">
                                عدد مرات السكن/الاستئجار سابقاً: <strong id="customer-history-count">0</strong>
                            </div>
                            <div class="form-group">
                                <label class="form-label">طريقة الحجز</label>
                                <select class="form-control" id="booking-method">
                                    <option value="phone">هاتف</option>
                                    <option value="booking">Booking.com</option>
                                    <option value="airbnb">Airbnb</option>
                                    <option value="other">أخرى</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 20px; margin-top: 10px;">تفاصيل الحجز والمالية</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label class="form-label">تاريخ البداية *</label>
                                    <input type="date" class="form-control" id="booking-start" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">تاريخ النهاية *</label>
                                    <input type="date" class="form-control" id="booking-end" required>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label class="form-label">عدد البالغين</label>
                                    <input type="number" min="0" step="1" class="form-control" id="booking-adults" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">عدد الأطفال</label>
                                    <input type="number" min="0" step="1" class="form-control" id="booking-children" value="0">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label class="form-label">إجمالي التكلفة (ر.ع)</label>
                                    <input type="number" step="0.001" class="form-control" id="booking-total" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">الخصم (ر.ع)</label>
                                    <input type="number" step="0.001" class="form-control" id="booking-discount" value="0">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label class="form-label">المبلغ المدفوع (ر.ع)</label>
                                    <input type="number" step="0.001" class="form-control" id="booking-paid" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">التأمين (ر.ع)</label>
                                    <input type="number" step="0.001" class="form-control" id="booking-deposit" value="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">حالة الحجز</label>
                                <select class="form-control" id="booking-status">
                                    <option value="confirmed">مؤكد</option>
                                    <option value="pending">معلق</option>
                                    <option value="cancelled">ملغي</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ملاحظات</label>
                        <textarea class="form-control" id="booking-notes"></textarea>
                    </div>

                    <div style="text-align: left; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="resetBookingForm()">إلغاء</button>
                        <button type="submit" class="btn btn-primary"><i class="fa-solid fa-save"></i> حفظ الحجز</button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Bookings List Page -->
        <section id="page-bookings">
            <div class="page-header">
                <h1 class="page-title">إدارة الحجوزات</h1>
                <button class="btn btn-primary" onclick="navigateTo('new-booking')"><i class="fa-solid fa-plus"></i> حجز جديد</button>
            </div>

            <div class="filters-bar">
                <div class="filter-item">
                    <input type="text" class="form-control" id="search-bookings" placeholder="بحث باسم العميل أو الهاتف..." onkeyup="loadBookings()">
                </div>
                <div class="filter-item">
                    <select class="form-control" id="filter-villa" onchange="loadBookings()">
                        <option value="">كل الفلل</option>
                        <option value="1">فيلا 1</option>
                        <option value="2">فيلا 2</option>
                        <option value="3">فيلا 3</option>
                        <option value="4">فيلا 4</option>
                    </select>
                </div>
                <div class="filter-item">
                    <select class="form-control" id="filter-month" onchange="loadBookings()">
                        <option value="">جميع الأشهر</option>
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>

            <div class="table-container">
                <div style="overflow-x: auto;">
                    <table id="bookings-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>العميل</th>
                                <th>الفيلا</th>
                                <th>المدة</th>
                                <th>البالغين</th>
                                <th>الأطفال</th>
                                <th>المبلغ</th>
                                <th>التأمين</th>
                                <th>الخصم</th>
                                <th>المبلغ المدفوع</th>
                                <th>المتبقي</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div id="bookings-summary" style="padding: 15px; background: #f8f9fa; border-top: 1px solid var(--border); text-align: left; font-weight: bold;">
                    إجمالي الحجوزات المعروضة: <span id="summary-total">0.000</span> ر.ع
                </div>
            </div>
        </section>

        <!-- Villa Expenses Page -->
        <section id="page-villa-expenses">
            <div class="page-header">
                <h1 class="page-title">مصاريف الفلل</h1>
                <button class="btn btn-primary" onclick="openExpenseModal('villa')"><i class="fa-solid fa-plus"></i> مصروف جديد</button>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchVillaTab(1)" id="tab-villa-1">فيلا 1</div>
                <div class="tab" onclick="switchVillaTab(2)" id="tab-villa-2">فيلا 2</div>
                <div class="tab" onclick="switchVillaTab(3)" id="tab-villa-3">فيلا 3</div>
                <div class="tab" onclick="switchVillaTab(4)" id="tab-villa-4">فيلا 4</div>
            </div>

            <div class="filters-bar">
                 <div class="filter-item">
                    <select class="form-control" id="filter-villa-expenses-month" onchange="loadVillaExpenses()">
                        <option value="">كل الأشهر</option>
                         <!-- Populated by JS -->
                    </select>
                </div>
            </div>

            <div class="table-container">
                <div style="overflow-x: auto;">
                    <table id="villa-expenses-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>النوع</th>
                                <th>التاريخ</th>
                                <th>المبلغ (ر.ع)</th>
                                <th>الوصف</th>
                                <th>إجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid var(--border); display:flex; justify-content:space-between; font-weight: bold;">
                   <span>إجمالي مصاريف الفيلا الحالية:</span>
                   <span id="villa-expenses-total">0.000 ر.ع</span>
                </div>
            </div>
        </section>

        <!-- Shared Expenses Page -->
        <section id="page-shared-expenses">
            <div class="page-header">
                <h1 class="page-title">المصاريف المشتركة</h1>
                <button class="btn btn-primary" onclick="openExpenseModal('shared')"><i class="fa-solid fa-plus"></i> مصروف جديد</button>
            </div>

            <div class="filters-bar">
                <div class="filter-item">
                    <select class="form-control" id="filter-shared-type" onchange="loadSharedExpenses()">
                        <option value="">كل الأنواع</option>
                        <option value="misc">نثريات</option>
                        <option value="advertising">إعلان</option>
                        <option value="phone">هاتف</option>
                        <option value="other">أخرى</option>
                    </select>
                </div>
                <div class="filter-item">
                    <select class="form-control" id="filter-shared-month" onchange="loadSharedExpenses()">
                         <option value="">كل الأشهر</option>
                         <!-- Populated by JS -->
                    </select>
                </div>
            </div>

            <div class="table-container">
                <div style="overflow-x: auto;">
                    <table id="shared-expenses-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>النوع</th>
                                <th>التاريخ</th>
                                <th>المبلغ (ر.ع)</th>
                                <th>الوصف</th>
                                <th>إجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                             <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                 <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid var(--border); display:flex; justify-content:space-between; font-weight: bold;">
                   <span>إجمالي المصاريف المشتركة:</span>
                   <span id="shared-expenses-total">0.000 ر.ع</span>
                </div>
            </div>
        </section>

        <!-- Employee Expenses Page -->
        <section id="page-employee-expenses">
            <div class="page-header">
                <h1 class="page-title">رواتب الموظفين</h1>
                <button class="btn btn-primary" onclick="openEmployeeModal()"><i class="fa-solid fa-plus"></i> إضافة موظف</button>
            </div>

            <div class="filters-bar">
                <div class="filter-item">
                    <select class="form-control" id="filter-employee-month" onchange="loadEmployeeExpenses()">
                        <option value="">كل الشهور</option>
                        <option value="01">يناير</option>
                        <option value="02">فبراير</option>
                        <option value="03">مارس</option>
                        <option value="04">أبريل</option>
                        <option value="05">مايو</option>
                        <option value="06">يونيو</option>
                        <option value="07">يوليو</option>
                        <option value="08">أغسطس</option>
                        <option value="09">سبتمبر</option>
                        <option value="10">أكتوبر</option>
                        <option value="11">نوفمبر</option>
                        <option value="12">ديسمبر</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <h3>سجل رواتب الموظفين</h3>
                    <div style="font-weight:700;">
                        الإجمالي: <span id="employee-expenses-total">0.000</span> ر.ع
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table id="employee-expenses-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>اسم الموظف</th>
                                <th>رقم بطاقة العمل</th>
                                <th>تاريخ انتهاء البطاقة</th>
                                <th>قيمة الراتب</th>
                                <th>مدفوعات أخرى</th>
                                <th>التاريخ</th>
                                <th>إجراء</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Settings Page -->
        <section id="page-settings">
            <div class="page-header">
                <h1 class="page-title">الإعدادات</h1>
            </div>

            <div class="cards-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="table-container" style="padding: 25px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">قاعدة البيانات المحلية</h3>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-right: 4px solid var(--success);">
                        <h4 style="color: var(--success); margin-bottom: 10px;">� تخزين محلي</h4>
                        <p style="margin-bottom: 10px;">النظام يعمل مع قاعدة البيانات:</p>
                        <ul style="margin-right: 20px; color: var(--text-secondary);">
                            <li><strong>اسم الملف:</strong> villa_database.sqlite</li>
                            <li><strong>الموقع:</strong> ذاكرة المتصفح المحلية</li>
                            <li><strong>التحديث:</strong> تلقائي وفوري</li>
                            <li><strong>الأمان:</strong> البيانات لا تضيع عند الإغلاق</li>
                        </ul>
                        <small style="color: var(--text-secondary);">💡 تعمل كقاعدة بيانات SQLite كاملة في المتصفح</small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn btn-primary" onclick="exportData()"><i class="fa-solid fa-download"></i> تصدير نسخة احتياطية</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()"><i class="fa-solid fa-upload"></i> استيراد من ملف</button>
                        <input type="file" id="import-file" accept=".json,.sqlite,.db" style="display: none;" onchange="importData(event)">
                    </div>
                </div>

                <div class="table-container" style="padding: 25px; border: 1px solid var(--danger);">
                    <h3 style="margin-bottom: 15px; color: var(--danger);">منطقة الخطر</h3>
                    <p style="margin-bottom: 20px; color: var(--text-secondary);">تحذير: هذا الإجراء سيقوم بمسح جميع البيانات المسجلة (حجوزات، مصاريف) ولا يمكن التراجع عنه.</p>
                    
                    <button class="btn btn-danger" onclick="clearAllData()"><i class="fa-solid fa-trash"></i> حذف جميع البيانات</button>
                </div>
            </div>
            
             <div class="table-container" style="padding: 25px;">
                <h3 style="margin-bottom: 15px; color: var(--primary);">تقارير النظام</h3>
                <div style="display: flex; gap: 15px; align-items: flex-end;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">من تاريخ</label>
                        <input type="date" class="form-control" id="report-start">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">إلى تاريخ</label>
                        <input type="date" class="form-control" id="report-end">
                    </div>
                    <button class="btn btn-primary" onclick="generateReport()"><i class="fa-solid fa-file-pdf"></i> إنشاء تقرير</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Report Modal -->
    <div class="modal-overlay" id="report-modal">
        <div class="modal" style="max-width: 900px; max-height: 95vh;">
            <div class="modal-header">
                <h3 class="modal-title">تقرير النظام</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-sm btn-secondary" onclick="printReport()"><i class="fa-solid fa-print"></i> طباعة</button>
                    <button class="btn btn-sm btn-secondary" onclick="closeModal('report-modal')"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>
            <div class="modal-body" id="report-content" style="max-height: 70vh; overflow-y: auto;">
                <!-- Report content will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- Modal: Add Expense (Villa or Shared) -->
    <div class="modal-overlay" id="expense-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="expense-modal-title">مصروف جديد</h3>
                <button class="btn btn-sm btn-secondary" onclick="closeModal('expense-modal')"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="expense-form" onsubmit="saveExpense(event)">
                    <input type="hidden" id="expense-type-category"> <!-- 'villa' or 'shared' -->
                    
                    <div class="form-group" id="villa-select-group">
                        <label class="form-label">الفيلا</label>
                        <select class="form-control" id="expense-villa-id">
                            <option value="1">فيلا 1</option>
                            <option value="2">فيلا 2</option>
                            <option value="3">فيلا 3</option>
                            <option value="4">فيلا 4</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">نوع المصروف</label>
                        <select class="form-control" id="expense-type-select" required>
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">التاريخ</label>
                        <input type="date" class="form-control" id="expense-date" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">المبلغ (ر.ع)</label>
                        <input type="number" step="0.001" class="form-control" id="expense-amount" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">الوصف</label>
                        <input type="text" class="form-control" id="expense-desc">
                    </div>

                    <div style="text-align: left; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('expense-modal')">إلغاء</button>
                        <button type="submit" class="btn btn-primary">حفظ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <div class="modal-overlay" id="employee-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="employee-modal-title">إضافة موظف</h3>
                <button class="btn btn-sm btn-secondary" onclick="closeModal('employee-modal')"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="employee-form" onsubmit="saveEmployeeExpense(event)">
                    <div class="form-group">
                        <label class="form-label">اسم الموظف *</label>
                        <input type="text" class="form-control" id="employee-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">رقم بطاقة العمل *</label>
                        <input type="text" class="form-control" id="employee-card-number" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">تاريخ انتهاء البطاقة *</label>
                        <input type="date" class="form-control" id="employee-card-expiry" required>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label class="form-label">قيمة الراتب (ر.ع) *</label>
                            <input type="number" class="form-control" id="employee-salary" step="0.001" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">مدفوعات أخرى (ر.ع)</label>
                            <input type="number" class="form-control" id="employee-other-payments" step="0.001" min="0" value="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">التاريخ *</label>
                        <input type="date" class="form-control" id="employee-expense-date" required>
                    </div>
                    <div class="modal-footer" style="padding: 0; border-top: none;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('employee-modal')">إلغاء</button>
                        <button type="submit" class="btn btn-primary"><i class="fa-solid fa-save"></i> حفظ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>


// --- Mobile detection + safe storage + date input polyfills (added) ---
(function() {
    // Detect mobile / touch devices (keeps the same visual style, only minor sizing adjustments)
    const ua = navigator.userAgent || '';
    const isTouch = (navigator.maxTouchPoints && navigator.maxTouchPoints > 0) || ('ontouchstart' in window);
    const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
    const isSmallScreen = Math.min(window.innerWidth || 0, window.innerHeight || 0) <= 820;
    const isMobile = isMobileUA || (isTouch && isSmallScreen);

    if (isMobile) document.body.classList.add('is-mobile');
    if (isTouch) document.body.classList.add('is-touch');

    // Some mobile browsers (especially iOS private mode) can throw on localStorage setItem/getItem.
    // We wrap them so booking/expense saving doesn't crash.
    const _ls = window.localStorage;
    const _get = _ls && _ls.getItem ? _ls.getItem.bind(_ls) : null;
    const _set = _ls && _ls.setItem ? _ls.setItem.bind(_ls) : null;
    const _remove = _ls && _ls.removeItem ? _ls.removeItem.bind(_ls) : null;
    const _clear = _ls && _ls.clear ? _ls.clear.bind(_ls) : null;
    const _mem = {};

    function safeGetItem(k) {
        try { return _get ? _get(k) : (_mem[k] ?? null); } catch (e) { return (_mem[k] ?? null); }
    }
    function safeSetItem(k, v) {
        try { if (_set) { _set(k, v); } else { _mem[k] = String(v); } }
        catch (e) { _mem[k] = String(v); }
    }
    function safeRemoveItem(k) {
        try { if (_remove) _remove(k); } catch (e) {}
        delete _mem[k];
    }
    function safeClear() {
        try { if (_clear) _clear(); } catch (e) {}
        for (const k in _mem) delete _mem[k];
    }
    if (_ls) {
        // Only override if native calls might throw; harmless otherwise.
        _ls.getItem = safeGetItem;
        _ls.setItem = safeSetItem;
        _ls.removeItem = safeRemoveItem;
        _ls.clear = safeClear;
    }

    // Polyfill / harden valueAsDate usage for <input type="date"> (some mobile browsers are picky).
    try {
        const proto = window.HTMLInputElement && window.HTMLInputElement.prototype;
        if (proto && !Object.getOwnPropertyDescriptor(proto, 'valueAsDate')) {
            Object.defineProperty(proto, 'valueAsDate', {
                get: function() {
                    if (this.type !== 'date' || !this.value) return null;
                    const d = new Date(this.value);
                    return isNaN(d.getTime()) ? null : d;
                },
                set: function(d) {
                    if (this.type !== 'date') return;
                    if (!(d instanceof Date) || isNaN(d.getTime())) { this.value = ''; return; }
                    const yyyy = d.getFullYear();
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    this.value = `${yyyy}-${mm}-${dd}`;
                }
            });
        }
    } catch (e) {
        // no-op
    }
})();

        // --- Constants & Global Variables ---
        let db = null;
        // sql.js module holder (set in initDatabase)
        let SQLModule = null;
        let activeVillaTab = 1;
        const DB_FILENAME = 'villa_database.sqlite'; // Conceptual filename
        
        const ARABIC_MONTHS = [
            'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
            'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
        ];

        let bookingChart = null;
        let revenueChart = null;
        let expensesChart = null;
        let methodsChart = null;

        // --- Initialization ---
        window.onload = async function() {
            try {
                await initDatabase();
                setupDates();
                setupCustomerHistoryListeners();
                populateMonthSelects();
                loadDashboard(); // Load dashboard by default
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (err) {
                console.error("Initialization failed:", err);
                alert("فشل تحميل النظام. يرجى التحقق من وحدة التحكم.");
            }
        };

        // --- Database Management ---
        async function initDatabase() {
            try {
                const sqlPromise = await window.initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                
                
                SQLModule = sqlPromise;
// Load from localStorage (conceptually villa_database.sqlite)
                const savedDb = localStorage.getItem('villa_db');
                if (savedDb) {
                    const uInt8Array = new Uint8Array(JSON.parse(savedDb));
                    db = new sqlPromise.Database(uInt8Array);
                
                    migrateDatabase();
                    saveDatabase();
} else {
                    db = new sqlPromise.Database();
                    createTables();
                    migrateDatabase();
                    saveDatabase();
                }
            } catch (e) {
                console.error(e);
                showToast("خطأ في تهيئة قاعدة البيانات", "error");
            }
        }



        function createTables() {
            db.run(`
                CREATE TABLE IF NOT EXISTS bookings (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    customer_name TEXT NOT NULL,
                    id_number TEXT,
                    phone TEXT NOT NULL,
                    villa_number INTEGER NOT NULL,
                    start_date TEXT NOT NULL,
                    end_date TEXT NOT NULL,
                    booking_method TEXT DEFAULT 'phone',
                    total_cost REAL DEFAULT 0,
                    discount REAL DEFAULT 0,
                    amount_paid REAL DEFAULT 0,
                    deposit REAL DEFAULT 0,
                    notes TEXT,
                    status TEXT DEFAULT 'confirmed',
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                    nationality TEXT DEFAULT \'أخرى\',
                    adults_count INTEGER DEFAULT 0,
                    children_count INTEGER DEFAULT 0
                );

                CREATE TABLE IF NOT EXISTS villa_expenses (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    villa_number INTEGER NOT NULL,
                    expense_type TEXT NOT NULL,
                    amount REAL NOT NULL,
                    expense_date TEXT NOT NULL,
                    description TEXT,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                );

                CREATE TABLE IF NOT EXISTS shared_expenses (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    expense_type TEXT NOT NULL,
                    amount REAL NOT NULL,
                    expense_date TEXT NOT NULL,
                    description TEXT,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                );

                CREATE TABLE IF NOT EXISTS employee_expenses (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    employee_name TEXT NOT NULL,
                    work_card_number TEXT NOT NULL,
                    card_expiry TEXT NOT NULL,
                    salary REAL NOT NULL,
                    other_payments REAL DEFAULT 0,
                    expense_date TEXT NOT NULL,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP
                );

            `);
        }


        // --- Database Migration (for older saved databases) ---
        function migrateDatabase() {
            try {
                const cols = db.exec("PRAGMA table_info(bookings)");
                const names = (cols && cols[0] && cols[0].values) ? cols[0].values.map(r => String(r[1])) : [];
                if (!names.includes('nationality')) {
                    db.run("ALTER TABLE bookings ADD COLUMN nationality TEXT DEFAULT 'أخرى'");
                }
                if (!names.includes('adults_count')) {
                    db.run("ALTER TABLE bookings ADD COLUMN adults_count INTEGER DEFAULT 0");
                }
                if (!names.includes('children_count')) {
                    db.run("ALTER TABLE bookings ADD COLUMN children_count INTEGER DEFAULT 0");
                }
            } catch (e) {
                console.warn("Migration warning:", e);
            }
        }

        function saveDatabase() {
            const data = db.export();
            const array = Array.from(data);
            localStorage.setItem('villa_db', JSON.stringify(array));
            // Conceptually saved as villa_database.sqlite in localStorage
        }

        // --- Navigation ---
        function navigateTo(pageId) {
            // Hide all pages
            document.querySelectorAll('section[id^="page-"]').forEach(sec => sec.classList.remove('active'));
            // Show target page
            document.getElementById(`page-${pageId}`).classList.add('active');
            
            // Update sidebar
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            // Find link with onclick matching
            const links = document.querySelectorAll('.nav-link');
            for(let link of links) {
                if(link.getAttribute('onclick').includes(pageId)) {
                    link.classList.add('active');
                    break;
                }
            }
            
            // Close mobile menu
            if(window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('mobile-open');
            }

            // Load page data
            if(pageId === 'bookings') loadBookings();
            if(pageId === 'villa-expenses') loadVillaExpenses();
            if(pageId === 'shared-expenses') loadSharedExpenses();
            if(pageId === 'employee-expenses') loadEmployeeExpenses();
            if(pageId === 'dashboard') loadDashboard();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        }

        // --- Bookings Logic ---
        // Search داخل قائمة الجنسية (لتسهيل الاختيار)
        function filterNationalityOptions(selectId, inputId) {
            const input = document.getElementById(inputId);
            const select = document.getElementById(selectId);
            if (!input || !select) return;

            const q = (input.value || '').trim().toLowerCase();

            Array.from(select.options).forEach(opt => {
                if (!q) {
                    opt.hidden = false;
                    return;
                }
                opt.hidden = !(opt.text || '').toLowerCase().includes(q);
            });

            // لو الخيار الحالي اختفى بعد الفلترة، اختر أول خيار ظاهر
            const current = select.selectedOptions && select.selectedOptions[0];
            if (current && current.hidden) {
                const firstVisible = Array.from(select.options).find(o => !o.hidden);
                if (firstVisible) select.value = firstVisible.value;
            }
        }


        let selectedVillas = new Set();

        function updateSelectedVillasUI() {
            const label = document.getElementById('selected-villas-label');
            const hidden = document.getElementById('booking-villa');
            const arr = Array.from(selectedVillas).sort((a,b)=>a-b);

            hidden.value = arr.join(',');

            if (label) {
                if (arr.length === 0) {
                    label.innerText = "لم يتم اختيار أي فيلا";
                } else if (arr.length === 1) {
                    label.innerText = "الفيلا المختارة: فيلا " + arr[0];
                } else {
                    label.innerText = "الفلل المختارة: " + arr.map(v => "فيلا " + v).join(" ، ");
                }
            }
        }

        function clearSelectedVillas() {
            selectedVillas = new Set();
            document.querySelectorAll('.villa-option').forEach(opt => opt.classList.remove('selected'));
            updateSelectedVillasUI();
        }

        // في وضع الإضافة: يمكن اختيار أكثر من فيلا (تحديد/إلغاء تحديد)
        // في وضع التعديل: يتم اختيار فيلا واحدة فقط للحجز الحالي
        function selectVilla(id, element, forceSingle = false) {
            const isEditMode = !!document.getElementById('edit-booking-id');
            const singleMode = forceSingle || isEditMode;

            if (singleMode) {
                // Single selection
                selectedVillas = new Set([parseInt(id)]);
                document.querySelectorAll('.villa-option').forEach(opt => opt.classList.remove('selected'));
                if (element) element.classList.add('selected');
                updateSelectedVillasUI();
                return;
            }

            // Multi selection (toggle)
            const vid = parseInt(id);
            if (selectedVillas.has(vid)) {
                selectedVillas.delete(vid);
                if (element) element.classList.remove('selected');
            } else {
                selectedVillas.add(vid);
                if (element) element.classList.add('selected');
            }
            updateSelectedVillasUI();
        }

        function resetBookingForm() {
            document.getElementById('new-booking-form').reset();
            // sync nationality display after reset
            const natSel = document.getElementById('booking-nationality');
            const natDisp = document.getElementById('booking-nationality-display');
            if (natSel && natDisp) { natDisp.value = natSel.value || ''; }
            clearSelectedVillas();
            document.getElementById('booking-villa').value = '';
            // Reset dates to today
            setupDates(); 
            // If we are in edit mode (hidden ID field exists), remove it
             const existingId = document.getElementById('edit-booking-id');
             if(existingId) existingId.remove();

            // Reset title (if changed by edit)
            const titleEl = document.querySelector('#page-new-booking .page-title');
            if (titleEl) titleEl.innerText = "حجز جديد";
        }
        
        
        function normalizeStr(s) {
            return String(s || '').trim().toLowerCase();
        }

        function getCustomerHistoryCount(name, phone, idNumber, excludeId) {
            const n = normalizeStr(name);
            const p = normalizeStr(phone);
            const i = normalizeStr(idNumber);

            if (!n && !p && !i) return 0;

            // Prefer strong identifiers if present
            let where = [];
            let params = [];

            if (p) { where.push("phone = ?"); params.push(phone.trim()); }
            if (i) { where.push("id_number = ?"); params.push(idNumber.trim()); }
            if (n) { where.push("LOWER(TRIM(customer_name)) = ?"); params.push(n); }

            const whereSql = where.length ? "(" + where.join(" OR ") + ")" : "1=0";
            let sql = `SELECT COUNT(*) FROM bookings WHERE ${whereSql}`;
            if (excludeId) { sql += " AND id != ?"; params.push(excludeId); }

            try {
                const r = db.exec(sql, params);
                return (r && r[0] && r[0].values && r[0].values[0]) ? (parseInt(r[0].values[0][0]) || 0) : 0;
            } catch (e) {
                console.warn(e);
                return 0;
            }
        }

        function updateCustomerHistoryUI() {
            const name = document.getElementById('booking-name')?.value || '';
            const phone = document.getElementById('booking-phone')?.value || '';
            const idNumber = document.getElementById('booking-id-num')?.value || '';
            const excludeId = document.getElementById('edit-booking-id')?.value || null;

            const count = getCustomerHistoryCount(name, phone, idNumber, excludeId);
            const el = document.getElementById('customer-history-count');
            if (el) el.textContent = String(count);
        }

        function setupCustomerHistoryListeners() {
            const ids = ['booking-name', 'booking-phone', 'booking-id-num'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', () => updateCustomerHistoryUI());
                el.addEventListener('blur', () => updateCustomerHistoryUI());
            });
            // Initial
            updateCustomerHistoryUI();
        }

        function hasBookingConflict(villaNumber, startDate, endDate, excludeId) {
            // Prevent overlaps (inclusive) for the same villa, ignoring cancelled bookings.
            // Overlap exists if NOT( existing.end < new.start OR existing.start > new.end )
            let sql = `
                SELECT COUNT(*) FROM bookings 
                WHERE villa_number = ? 
                  AND status != 'cancelled'
                  AND NOT (end_date < ? OR start_date > ?)
            `;
            let params = [villaNumber, startDate, endDate];

            if (excludeId) {
                sql += " AND id != ?";
                params.push(excludeId);
            }

            try {
                const r = db.exec(sql, params);
                const c = (r && r[0] && r[0].values && r[0].values[0]) ? (parseInt(r[0].values[0][0]) || 0) : 0;
                return c > 0;
            } catch (e) {
                console.warn(e);
                return false;
            }
        }

function saveBooking(e) {
            e.preventDefault();

            const villaValue = (document.getElementById('booking-villa').value || '').trim();
            const villas = villaValue
                .split(',')
                .map(v => parseInt(String(v).trim()))
                .filter(v => !isNaN(v));

            // إزالة التكرار
            const uniqueVillas = Array.from(new Set(villas));

            if(uniqueVillas.length === 0) {
                showToast("الرجاء اختيار الفيلا", "error");
                return;
            }

            const data = {
                name: document.getElementById('booking-name').value,
                phone: document.getElementById('booking-phone').value,
                id_num: document.getElementById('booking-id-num').value,
                
                nationality: document.getElementById('booking-nationality').value,
method: document.getElementById('booking-method').value,
                start: document.getElementById('booking-start').value,
                end: document.getElementById('booking-end').value,
                adults: parseInt(document.getElementById('booking-adults').value) || 0,
                children: parseInt(document.getElementById('booking-children').value) || 0,
                total: parseFloat(document.getElementById('booking-total').value) || 0,
                discount: parseFloat(document.getElementById('booking-discount').value) || 0,
                paid: parseFloat(document.getElementById('booking-paid').value) || 0,
                deposit: parseFloat(document.getElementById('booking-deposit').value) || 0,
                status: document.getElementById('booking-status').value,
                notes: document.getElementById('booking-notes').value,
                villas: uniqueVillas
            };
            
            // Check dates logic
            if(new Date(data.start) > new Date(data.end)) {
                 showToast("تاريخ النهاية يجب أن يكون بعد تاريخ البداية", "error");
                 return;
            }

            // Check for edit mode
            const editId = document.getElementById('edit-booking-id') ? document.getElementById('edit-booking-id').value : null;

            // في وضع التعديل: النظام يعدل حجز واحد فقط (فيلا واحدة)
            if (editId && data.villas.length > 1) {
                showToast("في وضع التعديل يمكن تعديل حجز فيلا واحدة فقط. الرجاء اختيار فيلا واحدة.", "error");
                return;
            }

            // Customer history count (updates UI and allows using the number anywhere)
            updateCustomerHistoryUI();

            // Prevent double booking for the same villa (overlapping dates)
            if (data.villas.some(v => hasBookingConflict(v, data.start, data.end, editId))) {
                const conflictVilla = data.villas.find(v => hasBookingConflict(v, data.start, data.end, editId));
                showToast('لا يمكن إضافة/تحديث الحجز: يوجد حجز آخر لفيلا ' + conflictVilla + ' يتداخل مع نفس الفترة.', 'error');
                return;
            }
try {
                if (editId) {
                    // Update
                     db.run(`UPDATE bookings SET 
                        customer_name = ?, id_number = ?, phone = ?, villa_number = ?, 
                        start_date = ?, end_date = ?, booking_method = ?, 
                        adults_count = ?, children_count = ?,
                        total_cost = ?, discount = ?, amount_paid = ?, deposit = ?, 
                        notes = ?, status = ?, nationality = ? WHERE id = ?`, 
                        [data.name, data.id_num, data.phone, data.villas[0], data.start, data.end, data.method,
                         data.adults, data.children,
                         data.total, data.discount, data.paid, data.deposit, data.notes, data.status, data.nationality, editId]
                    );
                    showToast("تم تحديث الحجز بنجاح", "success");
                } else {
                    // Insert (يمكن إدخال أكثر من فيلا في نفس العملية)
                    data.villas.forEach(v => {
                        db.run(`INSERT INTO bookings (customer_name, id_number, phone, villa_number, start_date, end_date, booking_method, adults_count, children_count, total_cost, discount, amount_paid, deposit, notes, status, nationality) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`, 
                            [data.name, data.id_num, data.phone, v, data.start, data.end, data.method, data.adults, data.children, data.total, data.discount, data.paid, data.deposit, data.notes, data.status, data.nationality]
                        );
                    });
                    showToast("تم إضافة الحجز بنجاح", "success");
                }
                
                saveDatabase();
                resetBookingForm();
                if(editId) navigateTo('bookings'); // Go back to list if editing
            } catch (err) {
                console.error(err);
                showToast("حدث خطأ أثناء حفظ الحجز", "error");
            }
        }

        function loadBookings() {
            const search = document.getElementById('search-bookings').value.trim();
            const villaFilter = document.getElementById('filter-villa').value;
            const monthFilter = document.getElementById('filter-month').value;
            
            let query = "SELECT * FROM bookings WHERE 1=1";
            let params = [];
            
            if(search) {
                query += " AND (customer_name LIKE ? OR phone LIKE ?)";
                params.push(`%${search}%`, `%${search}%`);
            }
            if(villaFilter) {
                query += " AND villa_number = ?";
                params.push(villaFilter);
            }
            if(monthFilter) {
                 query += " AND strftime('%m', start_date) = ?";
                 // Ensure two digits
                 params.push(monthFilter.padStart(2, '0'));
            }
            
            query += " ORDER BY start_date DESC";
            
            try {
                const result = db.exec(query, params);
                const tbody = document.querySelector('#bookings-table tbody');
                tbody.innerHTML = '';
                
                let totalAmount = 0;

                if (result.length > 0 && result[0].values.length > 0) {
                    result[0].values.forEach(row => {
                        const id = row[0];
                        const name = row[1];
                                                const idNumber = row[2] || "";
                        const phone = row[3] || "";
                        const villa = row[4];
                        const start = row[5];
                        const end = row[6];

                        const adults = Number(row[16] || 0);
                        const children = Number(row[17] || 0);

                        // المبلغ الكامل بدون نقص
                        const total = Number(row[8] || 0);

                        // الخصم يُخصم من إجمالي التكلفة
                        const discount = Number(row[9] || 0);

                        // المدفوع (بدون التأمين)
                        const paid = Number(row[10] || 0);

                        // التأمين مبلغ منفصل (لا يدخل ضمن المدفوعات)
                        const deposit = Number(row[11] || 0);

                        const status = row[13];

                        // المتبقي = (المبلغ الكامل - الخصم) - المدفوع
                        const remaining = Math.max(0, (total - discount) - paid);

                        totalAmount += total;

                        const rowHtml = `
                            <tr>
                                <td>${id}</td>
                                <td>${name}</td>
                                <td><span class="badge badge-villa-${villa}">فيلا ${villa}</span></td>
                                <td>${formatDate(start)} <br> <small>${formatDate(end)}</small></td>
                                <td>${adults}</td>
                                <td>${children}</td>
                                <td>${formatNumber(total)}</td>
                                <td>${formatNumber(deposit)}</td>
                                <td>${formatNumber(discount)}</td>
                                <td>${formatNumber(paid)}</td>
                                <td style="color: ${remaining > 0 ? 'var(--danger)' : 'var(--success)'}">${formatNumber(remaining)}</td>
                                <td><span class="badge badge-${status}">${translateStatus(status)}</span></td>
                                <td>
                                    <div class="action-btns">
                                        <button class="btn btn-sm btn-secondary" onclick="editBooking(${id})"><i class="fa-solid fa-edit"></i></button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteBooking(${id})"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += rowHtml;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="13" style="text-align:center;">لا توجد بيانات</td></tr>';
                }
                
                document.getElementById('summary-total').innerText = formatNumber(totalAmount);

            } catch (err) {
                console.error(err);
                showToast("خطأ في تحميل الحجوزات", "error");
            }
        }

        function editBooking(id) {
            try {
                const res = db.exec("SELECT * FROM bookings WHERE id = ?", [id]);
                if(res.length > 0) {
                    const data = res[0].values[0];
                    // Populate form
                    navigateTo('new-booking');
                    
                    document.getElementById('booking-name').value = data[1];
                    document.getElementById('booking-id-num').value = data[2];
                    document.getElementById('booking-phone').value = data[3];
                                        if(document.getElementById('booking-nationality')) document.getElementById('booking-nationality').value = (data[15] || 'أخرى');
selectVilla(data[4], document.getElementById(`villa-opt-${data[4]}`), true);
                    document.getElementById('booking-start').value = data[5];
                    document.getElementById('booking-end').value = data[6];
                    document.getElementById('booking-adults').value = Number(data[16] || 0);
                    document.getElementById('booking-children').value = Number(data[17] || 0);
                    document.getElementById('booking-method').value = data[7];
                    document.getElementById('booking-total').value = data[8];
                    document.getElementById('booking-discount').value = data[9];
                    document.getElementById('booking-paid').value = data[10];
                    document.getElementById('booking-deposit').value = data[11];
                    document.getElementById('booking-notes').value = data[12];
                    document.getElementById('booking-status').value = data[13];
                    
                    // Add hidden ID field
                    let hiddenInput = document.getElementById('edit-booking-id');
                    if(!hiddenInput) {
                        hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.id = 'edit-booking-id';
                        document.getElementById('new-booking-form').appendChild(hiddenInput);
                    }
                    hiddenInput.value = id;
                    
                    document.querySelector('#page-new-booking .page-title').innerText = "تعديل الحجز #" + id;
                }
            } catch(e) {
                 console.error(e);
            }
        }
        
        function deleteBooking(id) {
            if(confirm('هل أنت متأكد من حذف هذا الحجز؟')) {
                db.run("DELETE FROM bookings WHERE id = ?", [id]);
                saveDatabase();
                loadBookings();
                showToast("تم حذف الحجز", "info");
            }
        }

        function translateStatus(st) {
            const map = { 'confirmed': 'مؤكد', 'pending': 'معلق', 'cancelled': 'ملغي' };
            return map[st] || st;
        }

        // --- Expenses Logic ---
        function switchVillaTab(villaId) {
            activeVillaTab = villaId;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-villa-${villaId}`).classList.add('active');
            loadVillaExpenses();
        }

        function openExpenseModal(type) { // type: 'villa' or 'shared'
            const modal = document.getElementById('expense-modal');
            const title = document.getElementById('expense-modal-title');
            const typeSelect = document.getElementById('expense-type-select');
            const villaGroup = document.getElementById('villa-select-group');
            
            document.getElementById('expense-form').reset();
            document.getElementById('expense-date').valueAsDate = new Date(); // Today
            document.getElementById('expense-type-category').value = type;

            typeSelect.innerHTML = '';
            
            if(type === 'villa') {
                title.innerText = "مصروف فيلا جديد";
                villaGroup.style.display = 'block';
                document.getElementById('expense-villa-id').value = activeVillaTab;
                
                const opts = [
                    {val: 'electricity', text: 'كهرباء'},
                    {val: 'water', text: 'ماء'},
                    {val: 'laundry', text: 'غسيل'},
                    {val: 'maintenance', text: 'صيانة'},
                    {val: 'other', text: 'أخرى'}
                ];
                opts.forEach(o => typeSelect.add(new Option(o.text, o.val)));
            } else {
                title.innerText = "مصروف مشترك جديد";
                villaGroup.style.display = 'none';
                 const opts = [
                    {val: 'misc', text: 'نثريات'},
                    {val: 'advertising', text: 'إعلان'},
                    {val: 'phone', text: 'هاتف'},
                    {val: 'other', text: 'أخرى'}
                ];
                opts.forEach(o => typeSelect.add(new Option(o.text, o.val)));
            }
            
            modal.style.display = 'flex';
        }

        function saveExpense(e) {
            e.preventDefault();
            const category = document.getElementById('expense-type-category').value;
            const type = document.getElementById('expense-type-select').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const date = document.getElementById('expense-date').value;
            const desc = document.getElementById('expense-desc').value;
            
            if(category === 'villa') {
                const villa = document.getElementById('expense-villa-id').value;
                db.run(`INSERT INTO villa_expenses (villa_number, expense_type, amount, expense_date, description) VALUES (?,?,?,?,?)`,
                    [villa, type, amount, date, desc]);
                loadVillaExpenses();
            } else {
                 db.run(`INSERT INTO shared_expenses (expense_type, amount, expense_date, description) VALUES (?,?,?,?)`,
                    [type, amount, date, desc]);
                loadSharedExpenses();
            }
            
            saveDatabase();
            closeModal('expense-modal');
            showToast("تم حفظ المصروف", "success");
        }
        
        function loadVillaExpenses() {
            const month = document.getElementById('filter-villa-expenses-month').value;
             let query = `SELECT * FROM villa_expenses WHERE villa_number = ?`;
             let params = [activeVillaTab];
             
             if(month) {
                 query += ` AND strftime('%m', expense_date) = ?`;
                 params.push(month.padStart(2, '0'));
             }
             
             query += ` ORDER BY expense_date DESC`;
             
             const tbody = document.querySelector('#villa-expenses-table tbody');
             tbody.innerHTML = '';
             let total = 0;
             
             try {
                const res = db.exec(query, params);
                if(res.length > 0 && res[0].values.length > 0) {
                    res[0].values.forEach(row => {
                        total += row[3];
                        tbody.innerHTML += `
                            <tr>
                                <td>${row[0]}</td>
                                <td>${translateExpenseType(row[2])}</td>
                                <td>${formatDate(row[4])}</td>
                                <td>${formatNumber(row[3])}</td>
                                <td>${row[5] || '-'}</td>
                                <td><button class="btn btn-sm btn-danger" onclick="deleteVillaExpense(${row[0]})"><i class="fa-solid fa-trash"></i></button></td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">لا توجد بيانات</td></tr>';
                }
             } catch(e) { console.error(e); }
             
             document.getElementById('villa-expenses-total').innerText = formatNumber(total) + " ر.ع";
        }
        
        function deleteVillaExpense(id) {
             if(confirm('حذف هذا المصروف؟')) {
                 db.run("DELETE FROM villa_expenses WHERE id = ?", [id]);
                 saveDatabase();
                 loadVillaExpenses();
             }
        }
        
        function loadSharedExpenses() {
            const typeFilter = document.getElementById('filter-shared-type').value;
             const month = document.getElementById('filter-shared-month').value;
             
             let query = `SELECT * FROM shared_expenses WHERE 1=1`;
             let params = [];
             
             if(typeFilter) {
                 query += ` AND expense_type = ?`;
                 params.push(typeFilter);
             }
             
             if(month) {
                 query += ` AND strftime('%m', expense_date) = ?`;
                 params.push(month.padStart(2, '0'));
             }
             
             query += ` ORDER BY expense_date DESC`;
             
             const tbody = document.querySelector('#shared-expenses-table tbody');
             tbody.innerHTML = '';
             let total = 0;
             
             try {
                const res = db.exec(query, params);
                if(res.length > 0 && res[0].values.length > 0) {
                    res[0].values.forEach(row => {
                        total += row[2];
                        tbody.innerHTML += `
                            <tr>
                                <td>${row[0]}</td>
                                <td>${translateExpenseType(row[1])}</td>
                                <td>${formatDate(row[3])}</td>
                                <td>${formatNumber(row[2])}</td>
                                <td>${row[4] || '-'}</td>
                                <td><button class="btn btn-sm btn-danger" onclick="deleteSharedExpense(${row[0]})"><i class="fa-solid fa-trash"></i></button></td>
                            </tr>
                        `;
                    });
                } else {
                     tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">لا توجد بيانات</td></tr>';
                }
             } catch(e) { console.error(e); }
             
            document.getElementById('shared-expenses-total').innerText = formatNumber(total) + " ر.ع";
        }

        function deleteSharedExpense(id) {
             if(confirm('حذف هذا المصروف؟')) {
                 db.run("DELETE FROM shared_expenses WHERE id = ?", [id]);
                 saveDatabase();
                 loadSharedExpenses();
             }
        }


        // --- Employee Expenses Logic ---
        function openEmployeeModal() {
            const modal = document.getElementById('employee-modal');
            document.getElementById('employee-form').reset();
            document.getElementById('employee-expense-date').valueAsDate = new Date();
            modal.style.display = 'flex';
        }

        function loadEmployeeExpenses() {
            const month = document.getElementById('filter-employee-month').value;

            let query = `SELECT * FROM employee_expenses WHERE 1=1`;
            let params = [];

            if(month) {
                query += ` AND strftime('%m', expense_date) = ?`;
                params.push(month);
            }

            query += ` ORDER BY expense_date DESC`;

            const tbody = document.querySelector('#employee-expenses-table tbody');
            tbody.innerHTML = '';
            let total = 0;

            try {
                const res = db.exec(query, params);
                if(res.length > 0 && res[0].values.length > 0) {
                    res[0].values.forEach(row => {
                        // row: [id, employee_name, work_card_number, card_expiry, salary, other_payments, expense_date, created_at]
                        const salary = Number(row[4] || 0);
                        const other = Number(row[5] || 0);
                        total += (salary + other);

                        tbody.innerHTML += `
                            <tr>
                                <td>${row[0]}</td>
                                <td>${row[1] || '-'}</td>
                                <td>${row[2] || '-'}</td>
                                <td>${formatDate(row[3])}</td>
                                <td>${formatNumber(salary)}</td>
                                <td>${formatNumber(other)}</td>
                                <td>${formatDate(row[6])}</td>
                                <td><button class="btn btn-sm btn-danger" onclick="deleteEmployeeExpense(${row[0]})"><i class="fa-solid fa-trash"></i></button></td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">لا توجد بيانات</td></tr>';
                }
            } catch(e) { console.error(e); }

            document.getElementById('employee-expenses-total').innerText = formatNumber(total);
        }

        function saveEmployeeExpense(e) {
            e.preventDefault();

            const name = document.getElementById('employee-name').value.trim();
            const cardNo = document.getElementById('employee-card-number').value.trim();
            const expiry = document.getElementById('employee-card-expiry').value;
            const salary = parseFloat(document.getElementById('employee-salary').value || "0");
            const other = parseFloat(document.getElementById('employee-other-payments').value || "0");
            const date = document.getElementById('employee-expense-date').value;

            db.run(
                `INSERT INTO employee_expenses (employee_name, work_card_number, card_expiry, salary, other_payments, expense_date)
                 VALUES (?,?,?,?,?,?)`,
                [name, cardNo, expiry, salary, other, date]
            );

            saveDatabase();
            closeModal('employee-modal');
            loadEmployeeExpenses();
            showToast("تم حفظ بيانات الموظف", "success");
        }

        function deleteEmployeeExpense(id) {
            if(confirm('حذف هذا السجل؟')) {
                db.run("DELETE FROM employee_expenses WHERE id = ?", [id]);
                saveDatabase();
                loadEmployeeExpenses();
            }
        }

        function translateExpenseType(type) {
            const map = {
                'electricity': 'كهرباء', 'water': 'ماء', 'laundry': 'غسيل', 'maintenance': 'صيانة',
                'misc': 'نثريات', 'advertising': 'إعلان', 'phone': 'هاتف', 'other': 'أخرى', 'discount': 'خصومات'
            };
            return map[type] || type;
        }

        // --- Dashboard Logic ---
        function loadDashboard() {
            const period = document.getElementById('dashboard-period').value;
            let dateCondition = "1=1";
            let dateParams = [];
            
            // Show/hide custom date inputs
            const customInputs = document.getElementById('custom-period-inputs');
            if(period === 'custom') {
                customInputs.style.display = 'block';
            } else {
                customInputs.style.display = 'none';
            }
            
            const now = new Date();
            const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
            const currentYear = now.getFullYear();
            
            if(period === 'this_month') {
                dateCondition = "strftime('%Y-%m', start_date) = ?";
                dateParams = [`${currentYear}-${currentMonth}`];
            } else if(period === 'last_month') {
                 let lm = now.getMonth(); 
                 let ly = currentYear;
                 if(lm === 0) { lm = 12; ly--; }
                 dateCondition = "strftime('%Y-%m', start_date) = ?";
                 dateParams = [`${ly}-${lm.toString().padStart(2, '0')}`];
            } else if(period === 'this_year') {
                dateCondition = "strftime('%Y', start_date) = ?";
                dateParams = [`${currentYear}`];
            } else if(period === 'custom') {
                const startDate = document.getElementById('custom-start-date').value;
                const endDate = document.getElementById('custom-end-date').value;
                if(startDate && endDate) {
                    dateCondition = "start_date >= ? AND start_date <= ?";
                    dateParams = [startDate, endDate];
                } else if(startDate) {
                    dateCondition = "start_date >= ?";
                    dateParams = [startDate];
                } else if(endDate) {
                    dateCondition = "start_date <= ?";
                    dateParams = [endDate];
                }
            }

            // Stats
            try {
                const r1 = db.exec(`SELECT SUM(total_cost - discount), COUNT(*) FROM bookings WHERE ${dateCondition}`, dateParams);
                const revenue = r1[0]?.values[0][0] || 0;
                const count = r1[0]?.values[0][1] || 0;
                
                // Expenses (Approximate for period based on expense_date)
                const expDateCond = dateCondition.replace('start_date', 'expense_date');
                const r2 = db.exec(`SELECT SUM(amount) FROM villa_expenses WHERE ${expDateCond}`, dateParams);
                const r3 = db.exec(`SELECT SUM(amount) FROM shared_expenses WHERE ${expDateCond}`, dateParams);
                const expenses = (r2[0]?.values[0][0] || 0) + (r3[0]?.values[0][0] || 0);
                
                document.getElementById('stat-revenue').innerText = formatNumber(revenue);
                document.getElementById('stat-bookings-count').innerText = count;
                document.getElementById('stat-expenses').innerText = formatNumber(expenses);
                document.getElementById('stat-net').innerText = formatNumber(revenue - expenses);

                // Recent Bookings
                const recent = db.exec("SELECT id, customer_name, villa_number, start_date, end_date, adults_count, children_count, total_cost, discount, amount_paid, deposit, status FROM bookings ORDER BY id DESC LIMIT 5");
                const rbBody = document.querySelector('#recent-bookings-table tbody');
                rbBody.innerHTML = '';
                if(recent.length > 0 && recent[0].values.length > 0) {
                    recent[0].values.forEach(r => {
                        const adults = Number(r[5] || 0);
                        const children = Number(r[6] || 0);
                        const total = Number(r[7] || 0);
                        const discount = Number(r[8] || 0);
                        const paid = Number(r[9] || 0);
                        const deposit = Number(r[10] || 0);
                        const remaining = Math.max(0, (total - discount) - paid);

                        rbBody.innerHTML += `
                            <tr>
                                <td>${r[0]}</td>
                                <td>${r[1]}</td>
                                <td>فيلا ${r[2]}</td>
                                <td>${formatDate(r[3])} <br> <small>${formatDate(r[4])}</small></td>
                                <td>${adults}</td>
                                <td>${children}</td>
                                <td>${formatNumber(total)}</td>
                                <td>${formatNumber(deposit)}</td>
                                <td>${formatNumber(discount)}</td>
                                <td>${formatNumber(paid)}</td>
                                <td style="color: ${remaining > 0 ? 'var(--danger)' : 'var(--success)'}">${formatNumber(remaining)}</td>
                                <td><span class="badge badge-${r[9]}">${translateStatus(r[9])}</span></td>
                            </tr>
                         `;
                    });
                } else {
                     rbBody.innerHTML = '<tr><td colspan="12" style="text-align:center">لا يوجد حجوزات</td></tr>';
                }

                updateCharts();

            } catch(e) { console.error(e); }
        }

        function updateCharts() {
            // Data for charts logic
            // 1. Revenue per month (Last 6 months)
            // 2. Bookings per villa
            
            // Villa Distribution
            try {
                const res = db.exec("SELECT villa_number, COUNT(*) FROM bookings GROUP BY villa_number");
                const villaCounts = [0,0,0,0];
                if(res.length > 0) {
                    res[0].values.forEach(r => {
                        if(r[0] >= 1 && r[0] <= 4) villaCounts[r[0]-1] = r[1];
                    });
                }
                
                if(bookingChart) bookingChart.destroy();
                const ctx = document.getElementById('villasChart').getContext('2d');
                bookingChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['فيلا 1', 'فيلا 2', 'فيلا 3', 'فيلا 4'],
                        datasets: [{
                            data: villaCounts,
                            backgroundColor: ['#1565c0', '#7b1fa2', '#ef6c00', '#2e7d32']
                        }]
                    },
                     options: { 
                         responsive: true, 
                         maintainAspectRatio: true,
                         aspectRatio: 1,
                         plugins: {
                             legend: {
                                 position: 'bottom'
                             }
                         }
                     }
                });


                // Revenue Line Chart (Last 6 months)
                const labels = [];
                const dataRev = [];
                const today = new Date();
                
                for(let i=5; i>=0; i--) {
                    const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const mStr = (d.getMonth() + 1).toString().padStart(2,'0');
                    const yStr = d.getFullYear();
                    const key = `${yStr}-${mStr}`;
                    labels.push(ARABIC_MONTHS[d.getMonth()]); // Use Arabic name
                    
                    const q = db.exec(`SELECT SUM(total_cost - discount) FROM bookings WHERE strftime('%Y-%m', start_date) = '${key}'`);
                    dataRev.push(q[0]?.values[0][0] || 0);
                }

                if(revenueChart) revenueChart.destroy();
                const ctx2 = document.getElementById('revenueChart').getContext('2d');
                revenueChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'الإيرادات',
                            data: dataRev,
                            borderColor: '#1a5f4a',
                            tension: 0.3,
                            fill: true,
                            backgroundColor: 'rgba(26, 95, 74, 0.1)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // Booking Methods
                const methodsRes = db.exec("SELECT booking_method, COUNT(*) FROM bookings GROUP BY booking_method");
                const methodLabels = [];
                const methodData = [];
                const methodMap = {'phone': 'هاتف', 'booking': 'Booking', 'airbnb': 'Airbnb', 'other': 'أخرى'};
                
                if(methodsRes.length > 0) {
                    methodsRes[0].values.forEach(r => {
                        methodLabels.push(methodMap[r[0]] || r[0]);
                        methodData.push(r[1]);
                    });
                }

                if(methodsChart) methodsChart.destroy();
                methodsChart = new Chart(document.getElementById('methodsChart'), {
                    type: 'bar',
                    data: {
                        labels: methodLabels,
                        datasets: [{
                             label: 'عدد الحجوزات',
                            data: methodData,
                            backgroundColor: '#c9a227'
                        }]
                    },
                     options: { responsive: true, maintainAspectRatio: false, scales: {y: {beginAtZero: true, ticks: {stepSize: 1}}} }
                });

                 // Expenses Type Distribution
                 // Combine villa + shared expenses (filtered by dashboard period) + include discounts as an item
                 let expMap = {};
                 const expDateCond = dateCondition.replace('start_date', 'expense_date');

                 const rExp1 = db.exec(`SELECT expense_type, SUM(amount) FROM villa_expenses WHERE ${expDateCond} GROUP BY expense_type`, dateParams);
                 if(rExp1.length) rExp1[0].values.forEach(r => expMap[r[0]] = (expMap[r[0]]||0) + (r[1] || 0));

                 const rExp2 = db.exec(`SELECT expense_type, SUM(amount) FROM shared_expenses WHERE ${expDateCond} GROUP BY expense_type`, dateParams);
                 if(rExp2.length) rExp2[0].values.forEach(r => expMap[r[0]] = (expMap[r[0]]||0) + (r[1] || 0));

                 // Discounts (from bookings) are treated as a reducing factor, shown here for clarity
                 const rDisc = db.exec(`SELECT SUM(discount) FROM bookings WHERE ${dateCondition}`, dateParams);
                 const discTotal = rDisc[0]?.values[0][0] || 0;
                 if(discTotal > 0) expMap['discount'] = (expMap['discount']||0) + discTotal;

                 const expLabels = Object.keys(expMap).map(k => translateExpenseType(k));
                 const expData = Object.values(expMap);
                 if(expensesChart) expensesChart.destroy();
                expensesChart = new Chart(document.getElementById('expensesChart'), {
                    type: 'pie',
                    data: {
                        labels: expLabels,
                        datasets: [{
                            data: expData,
                            backgroundColor: ['#ef5350', '#ab47bc', '#42a5f5', '#26a69a', '#ffa726', '#8d6e63']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });


            } catch(e) { console.warn("Chart Error", e); }
        }

        // --- Settings & Utils ---
// Backup format:
// - Default export is JSON (portable across PC & mobile).
// - Import supports JSON backups and also raw .sqlite/.db exported previously.
function exportData() {
    try {
        // Export as portable JSON (recommended)
        const backup = {
            app: "villa-booking-manager",
            version: 1,
            created_at: new Date().toISOString(),
            tables: {
                bookings: dumpTable("bookings"),
                villa_expenses: dumpTable("villa_expenses"),
                shared_expenses: dumpTable("shared_expenses"),
                employee_expenses: dumpTable("employee_expenses")
            }
        };

        const json = JSON.stringify(backup);
        const blob = new Blob([json], { type: "application/json;charset=utf-8" });

        const a = document.createElement("a");
        const url = window.URL.createObjectURL(blob);
        a.href = url;
        a.download = `villa_backup_${new Date().toISOString().split("T")[0]}.json`;
        a.click();
        window.URL.revokeObjectURL(url);

    } catch (e) {
        console.error(e);
        showToast("تعذر تصدير النسخة الاحتياطية", "error");
    }
}

// Convert a table to array of objects (keeps column names)
function dumpTable(tableName) {
    try {
        const res = db.exec(`SELECT * FROM ${tableName}`);
        if (!res || !res.length) return [];
        const cols = res[0].columns;
        return res[0].values.map(row => {
            const obj = {};
            for (let i = 0; i < cols.length; i++) obj[cols[i]] = row[i];
            return obj;
        });
    } catch (e) {
        // If table doesn't exist for any reason, return empty
        return [];
    }
}

async function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    // reset input so selecting same file again triggers change
    event.target.value = "";

    try {
        // Read as ArrayBuffer first (works for both binary & text)
        const buf = await file.arrayBuffer();

        // 1) Try JSON backup (portable)
        const text = new TextDecoder("utf-8").decode(new Uint8Array(buf));
        const trimmed = (text || "").trim();

        if (trimmed.startsWith("{") || file.name.toLowerCase().endsWith(".json")) {
            const parsed = JSON.parse(trimmed);
            await restoreFromJsonBackup(parsed);
            showToast("تم استعادة البيانات من النسخة الاحتياطية بنجاح", "success");
            setTimeout(() => location.reload(), 1200);
            return;
        }

        // 2) Fallback: raw SQLite backup
        if (!SQLModule) {
            // If initDatabase didn't set it yet, try to init now (rare)
            SQLModule = await window.initSqlJs({
                locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}`
            });
        }

        const uInt8Array = new Uint8Array(buf);
        const newDb = new SQLModule.Database(uInt8Array);

        // Ensure tables exist (in case an empty DB was imported)
        db = newDb;
        createTables();
        saveDatabase();

        showToast("تم استعادة قاعدة البيانات بنجاح", "success");
        setTimeout(() => location.reload(), 1200);

    } catch (e) {
        console.error(e);
        alert("ملف قاعدة بيانات غير صالح");
    }
}

async function restoreFromJsonBackup(backup) {
    // Basic validation
    if (!backup || typeof backup !== "object" || !backup.tables) {
        throw new Error("Invalid JSON backup structure");
    }

    // Make sure sql.js module exists
    if (!SQLModule) {
        SQLModule = await window.initSqlJs({
            locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${f}`
        });
    }

    // Create a fresh DB, then import rows
    if (db && db.close) {
        try { db.close(); } catch (e) {}
    }
    db = new SQLModule.Database();
    createTables();

    // Clean existing data
    db.run("DELETE FROM bookings;");
    db.run("DELETE FROM villa_expenses;");
    db.run("DELETE FROM shared_expenses;");
    db.run("DELETE FROM employee_expenses;");

    // Insert rows (keep IDs/created_at if present)
    insertRows("bookings", backup.tables.bookings || []);
    insertRows("villa_expenses", backup.tables.villa_expenses || []);
    insertRows("shared_expenses", backup.tables.shared_expenses || []);
    insertRows("employee_expenses", backup.tables.employee_expenses || []);

    saveDatabase();
}

function insertRows(tableName, rows) {
    if (!Array.isArray(rows) || rows.length === 0) return;

    // Whitelist tables for safety
    const allowed = new Set(["bookings", "villa_expenses", "shared_expenses", "employee_expenses"]);
    if (!allowed.has(tableName)) return;

    // Use keys from first row, but keep only scalar values
    const cols = Object.keys(rows[0] || {}).filter(k => k && k !== "__proto__");

    if (cols.length === 0) return;

    const placeholders = cols.map(() => "?").join(",");
    const sql = `INSERT OR REPLACE INTO ${tableName} (${cols.join(",")}) VALUES (${placeholders})`;

    const stmt = db.prepare(sql);
    try {
        for (const r of rows) {
            const vals = cols.map(c => (r && Object.prototype.hasOwnProperty.call(r, c)) ? r[c] : null);
            stmt.run(vals);
        }
    } finally {
        stmt.free();
    }
}

        function clearAllData() {
            if(confirm("تحذير نهائي: هل أنت متأكد من حذف جميع البيانات؟ لا يمكن التراجع!")) {
                db.close(); 
                db = new SQLModule.Database();
                createTables();
                saveDatabase();
                location.reload();
            }
        }

        function generateReport() {
            const start = document.getElementById('report-start').value;
            const end = document.getElementById('report-end').value;
            if(!start || !end) {
                showToast("يرجى تحديد الفترة", "error");
                return;
            }
            
            if(new Date(start) > new Date(end)) {
                showToast("تاريخ النهاية يجب أن يكون بعد تاريخ البداية", "error");
                return;
            }

            try {
                const reportData = generateReportData(start, end);
                displayReport(reportData, start, end);
                document.getElementById('report-modal').style.display = 'flex';
            } catch(e) {
                console.error(e);
                showToast("خطأ في إنشاء التقرير", "error");
            }
        }

        function generateReportData(startDate, endDate) {
            const report = {
                bookings: [],
                villaExpenses: [],
                sharedExpenses: [],
                summary: {
                    totalRevenue: 0,
                    totalExpenses: 0,
                    netProfit: 0,
                    bookingsCount: 0,
                    avgBookingValue: 0
                },
                villaStats: {}
            };

            // Get bookings in date range
            const bookingsQuery = `SELECT * FROM bookings WHERE start_date >= ? AND start_date <= ? ORDER BY start_date DESC`;
            const bookingsResult = db.exec(bookingsQuery, [startDate, endDate]);
            
            if (bookingsResult.length > 0) {
                bookingsResult[0].values.forEach(row => {
                    const booking = {
                        id: row[0],
                        customer_name: row[1],
                        phone: row[3],
                        villa_number: row[4],
                        start_date: row[5],
                        end_date: row[6],
                        booking_method: row[7],
                        total_cost: row[8],
                        amount_paid: row[10],
                        status: row[13]
                    };
                    report.bookings.push(booking);
                    report.summary.totalRevenue += booking.total_cost;
                    
                    // Villa stats
                    if (!report.villaStats[booking.villa_number]) {
                        report.villaStats[booking.villa_number] = {
                            count: 0,
                            revenue: 0
                        };
                    }
                    report.villaStats[booking.villa_number].count++;
                    report.villaStats[booking.villa_number].revenue += booking.total_cost;
                });
                report.summary.bookingsCount = report.bookings.length;
                report.summary.avgBookingValue = report.summary.totalRevenue / report.summary.bookingsCount;
            }

            // Get villa expenses in date range
            const villaExpQuery = `SELECT * FROM villa_expenses WHERE expense_date >= ? AND expense_date <= ? ORDER BY expense_date DESC`;
            const villaExpResult = db.exec(villaExpQuery, [startDate, endDate]);
            
            if (villaExpResult.length > 0) {
                villaExpResult[0].values.forEach(row => {
                    const expense = {
                        id: row[0],
                        villa_number: row[1],
                        expense_type: row[2],
                        amount: row[3],
                        expense_date: row[4],
                        description: row[5]
                    };
                    report.villaExpenses.push(expense);
                    report.summary.totalExpenses += expense.amount;
                });
            }

            // Get shared expenses in date range
            const sharedExpQuery = `SELECT * FROM shared_expenses WHERE expense_date >= ? AND expense_date <= ? ORDER BY expense_date DESC`;
            const sharedExpResult = db.exec(sharedExpQuery, [startDate, endDate]);
            
            if (sharedExpResult.length > 0) {
                sharedExpResult[0].values.forEach(row => {
                    const expense = {
                        id: row[0],
                        expense_type: row[1],
                        amount: row[2],
                        expense_date: row[3],
                        description: row[4]
                    };
                    report.sharedExpenses.push(expense);
                    report.summary.totalExpenses += expense.amount;
                });
            }

            report.summary.netProfit = report.summary.totalRevenue - report.summary.totalExpenses;
            return report;
        }

        function displayReport(reportData, startDate, endDate) {
            const content = document.getElementById('report-content');
            const startFormatted = formatDate(startDate);
            const endFormatted = formatDate(endDate);
            
            let html = `
                <div class="report-header" style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--border);">
                    <h2 style="color: var(--primary); margin-bottom: 10px;">تقرير نظام إدارة الفلل</h2>
                    <p style="color: var(--text-secondary);">من ${startFormatted} إلى ${endFormatted}</p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">تاريخ الإنشاء: ${formatDate(new Date().toISOString().split('T')[0])}</p>
                </div>

                <!-- Financial Summary -->
                <div class="report-section" style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">الملخص المالي</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="report-stat" style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${formatNumber(reportData.summary.totalRevenue)} ر.ع</div>
                            <div style="color: var(--text-secondary);">إجمالي الإيرادات</div>
                        </div>
                        <div class="report-stat" style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--danger);">${formatNumber(reportData.summary.totalExpenses)} ر.ع</div>
                            <div style="color: var(--text-secondary);">إجمالي المصاريف</div>
                        </div>
                        <div class="report-stat" style="background: ${reportData.summary.netProfit >= 0 ? '#e8f5e9' : '#ffebee'}; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${reportData.summary.netProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatNumber(reportData.summary.netProfit)} ر.ع</div>
                            <div style="color: var(--text-secondary);">صافي الربح</div>
                        </div>
                        <div class="report-stat" style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--info);">${reportData.summary.bookingsCount}</div>
                            <div style="color: var(--text-secondary);">عدد الحجوزات</div>
                        </div>
                    </div>
                </div>

                <!-- Villa Statistics -->
                <div class="report-section" style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">إحصائيات الفلل</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            `;

            // Villa stats
            for (let i = 1; i <= 4; i++) {
                const villaData = reportData.villaStats[i] || { count: 0, revenue: 0 };
                const villaColors = {
                    1: '#e3f2fd',
                    2: '#f3e5f5', 
                    3: '#fff3e0',
                    4: '#e8f5e9'
                };
                
                html += `
                    <div style="background: ${villaColors[i]}; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-weight: bold; color: var(--text-primary); margin-bottom: 10px;">فيلا ${i}</div>
                        <div style="margin-bottom: 5px;">${villaData.count} حجز</div>
                        <div>${formatNumber(villaData.revenue)} ر.ع</div>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>

                <!-- Bookings Details -->
                <div class="report-section" style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">تفاصيل الحجوزات</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid var(--border); text-align: right;">العميل</th>
                                    <th style="padding: 10px; border: 1px solid var(--border); text-align: right;">الفيلا</th>
                                    <th style="padding: 10px; border: 1px solid var(--border); text-align: right;">التاريخ</th>
                                    <th style="padding: 10px; border: 1px solid var(--border); text-align: right;">الطريقة</th>
                                    <th style="padding: 10px; border: 1px solid var(--border); text-align: right;">المبلغ</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            if (reportData.bookings.length > 0) {
                reportData.bookings.forEach(booking => {
                    html += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid var(--border);">${booking.customer_name}</td>
                            <td style="padding: 8px; border: 1px solid var(--border);">فيلا ${booking.villa_number}</td>
                            <td style="padding: 8px; border: 1px solid var(--border);">${formatDate(booking.start_date)}</td>
                            <td style="padding: 8px; border: 1px solid var(--border);">${translateBookingMethod(booking.booking_method)}</td>
                            <td style="padding: 8px; border: 1px solid var(--border);">${formatNumber(booking.total_cost)} ر.ع</td>
                        </tr>
                    `;
                });
            } else {
                html += '<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--text-secondary);">لا توجد حجوزات في هذه الفترة</td></tr>';
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Expenses Summary -->
                <div class="report-section" style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">ملخص المصاريف</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        
                        <div>
                            <h4 style="color: var(--text-primary); margin-bottom: 10px;">مصاريف الفلل</h4>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
            `;

            if (reportData.villaExpenses.length > 0) {
                reportData.villaExpenses.forEach(expense => {
                    html += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                            <span>فيلا ${expense.villa_number} - ${translateExpenseType(expense.expense_type)}</span>
                            <span>${formatNumber(expense.amount)} ر.ع</span>
                        </div>
                    `;
                });
            } else {
                html += '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">لا توجد مصاريف</div>';
            }

            html += `
                            </div>
                        </div>

                        <div>
                            <h4 style="color: var(--text-primary); margin-bottom: 10px;">المصاريف المشتركة</h4>
                            <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px;">
            `;

            if (reportData.sharedExpenses.length > 0) {
                reportData.sharedExpenses.forEach(expense => {
                    html += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                            <span>${translateExpenseType(expense.expense_type)}</span>
                            <span>${formatNumber(expense.amount)} ر.ع</span>
                        </div>
                    `;
                });
            } else {
                html += '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">لا توجد مصاريف</div>';
            }

            html += `
                            </div>
                        </div>
                    </div>
                </div>
            `;

            content.innerHTML = html;
        }

        function translateBookingMethod(method) {
            const methods = {
                'phone': 'هاتف',
                'booking': 'Booking.com',
                'airbnb': 'Airbnb', 
                'other': 'أخرى'
            };
            return methods[method] || method;
        }

        function printReport() {
            const content = document.getElementById('report-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير نظام إدارة الفلل</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    ${content}
                

</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // --- Helpers ---
        function formatNumber(num) {
            return parseFloat(num).toFixed(3);
        }
        
        function formatDate(dateStr) {
            if(!dateStr) return '';
            const d = new Date(dateStr);
            return `${d.getDate()} ${ARABIC_MONTHS[d.getMonth()]} ${d.getFullYear()}`;
        }
        
        function populateMonthSelects() {
            const selects = ['filter-month', 'filter-villa-expenses-month', 'filter-shared-month'];
            selects.forEach(id => {
               const el = document.getElementById(id);
               if(el) {
                   ARABIC_MONTHS.forEach((m, idx) => {
                       el.add(new Option(m, (idx+1).toString()));
                   });
               } 
            });
        }
        
        function setupDates() {
            const today = new Date().toISOString().split('T')[0];
            const ins = document.querySelectorAll('input[type="date"]');
            ins.forEach(i => {
                if(!i.value) i.value = today;
            });
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }


        // Nationality searchable picker (opens a modal with built-in search)
        let __natSelectId = null;
        let __natDisplayId = null;

        function openNationalityModal(selectId, displayId){
            __natSelectId = selectId;
            __natDisplayId = displayId;

            const modal = document.getElementById('nationalityModal');
            const select = document.getElementById(selectId);
            const display = document.getElementById(displayId);
            const search = document.getElementById('nationalityModalSearch');
            const list = document.getElementById('nationalityModalList');

            if(!modal || !select || !display || !search || !list) return;

            // Ensure display is synced with current value
            display.value = select.value || display.value || '';

            function render(q){
                const query = (q || '').trim().toLowerCase();
                const selected = (select.value || '').trim();
                const options = Array.from(select.options).map(o => ({text:o.text, value:o.value}));
                const filtered = !query ? options : options.filter(o => (o.text || o.value || '').toLowerCase().includes(query));

                list.innerHTML = '';
                if(filtered.length === 0){
                    const empty = document.createElement('div');
                    empty.className = 'nationality-empty';
                    empty.textContent = 'لا توجد نتائج';
                    list.appendChild(empty);
                    return;
                }

                filtered.forEach(o=>{
                    const item = document.createElement('div');
                    item.className = 'nationality-item' + ((o.value===selected || o.text===selected) ? ' active' : '');
                    item.innerHTML = `<span>${o.text}</span><i class="fa-regular fa-circle-check" style="opacity:${(o.value===selected || o.text===selected)?1:0};"></i>`;
                    item.onclick = ()=>{
                        select.value = o.value;
                        display.value = o.text;
                        closeModal('nationalityModal');
                    };
                    list.appendChild(item);
                });
            }

            // bind search
            search.oninput = ()=> render(search.value);

            // initial render
            search.value = '';
            render('');

            modal.style.display = 'flex';
            setTimeout(()=>{ try{ search.focus(); }catch(e){} }, 60);
        }

        // Sync display value on page load (and after resets)
        document.addEventListener('DOMContentLoaded', ()=>{
            const sel = document.getElementById('booking-nationality');
            const disp = document.getElementById('booking-nationality-display');
            if(sel && disp){
                disp.value = sel.value || '';
            }
        });
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fa-info-circle';
            if(type === 'success') icon = 'fa-check-circle';
            if(type === 'error') icon = 'fa-exclamation-circle';
            
            toast.innerHTML = `
                <span>${message}</span>
                <i class="fa-solid ${icon}"></i>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    
</script>

<!-- Nationality Picker Modal -->
<div class="modal-overlay" id="nationalityModal" onclick="if(event.target===this){ closeModal('nationalityModal'); }">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="nationalityModalTitle" onclick="event.stopPropagation();">
        <div class="modal-header">
            <div class="modal-title" id="nationalityModalTitle">اختر الجنسية</div>
            <button class="btn btn-secondary" type="button" onclick="closeModal('nationalityModal')">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="modal-body">
            <input type="text" class="form-control" id="nationalityModalSearch" placeholder="ابحث عن الجنسية...">
            <div id="nationalityModalList" class="nationality-list"></div>
        </div>
    </div>
</div>

</body>
</html>
